var profile={config:{dataLength:0},columnsIndex:{grouped:["method","name","count","avgElapsed","maxElapsed","minElapsed"],filter:["method","name","elapsed","startedAt"]},getData:function(e,t){e=e||"grouped";var a,n=this;t=this.createQueryParams(e);return $.ajax({type:"GET",async:!1,url:"api/measurements/"+("grouped"===e?e+"/":""),dataType:"json",data:t,success:function(e){a=n.dataTableClassifier(e.measurements),n.createdTime=moment()}}),a},dataTableClassifier:function(e){var t=this.dataTableOption;ajaxData=e.measurements||e;var a=Object.keys(ajaxData).length;return a=t.length===a?t.length+t.start+a:t.start+a,{draw:t.draw,recordsFiltered:a,recordsTotal:a,data:ajaxData}},createQueryParams:function(e,t){var a,n=t||this.dataTableOption,r=n.order[0],i={};if("filtered"===e){var d=$("#filteredTable select.method").val();a=this.columnsIndex.filter,"ALL"===d&&(d=""),i.method=d,i.name=$("#filteredTable input.filtered-name").val(),i.elapsed=$("#filteredTable input.elapsed").val()||0}else a=this.columnsIndex.grouped;return i.sort=a[r.column]+","+r.dir,i.skip=n.start,i.limit=n.length,i.startedAt=this.dateTime.startedAt,i.endedAt=this.dateTime.endedAt,i}};window.profile=profile,window.dayFilterValue="day",window.profile.dateTime={startedAt:moment().subtract(6,"days").unix(),endedAt:moment().unix()};var setFilteredTable=function(){var e=$("#filteredTable").DataTable({processing:!0,serverSide:!0,ajax:function(e,t,a){window.profile.dataTableOption=e,t(window.profile.getData("filtered"))},responsive:!1,paging:!0,pageLength:100,dom:"Btrtip",stateSave:!0,order:[3,"desc"],autoWidth:!1,language:{processing:"Loading...",buttons:{colvis:'<span class="glyphicon glyphicon-filter"></span>'}},buttons:[{extend:"colvis",columns:[":gt(1)"]}],columns:[{title:"method",data:function(e){var t=$("<span></span>");return t.addClass("row--method"),t.addClass(e.method.toLowerCase()),t.text(e.method),t.prop("outerHTML")},class:"method",orderable:!1},{title:"name",data:function(e,t){var a=document.createElement("div");if(a.textContent=e.name,"display"===t){var n=$("<span></span>");return n.data("json",e.context),n.text(a.textContent),n.prop("outerHTML")}return a.textContent},class:"name",orderable:!1},{title:"elapsed",data:function(e){return e.elapsed.toString().slice(0,8)},class:"elapsed number"},{title:"startedAt",data:function(e){return moment.unix(e.startedAt).format("DD/MM/YYYY h:mm:ss.MS A")},class:"startedAt"}],initComplete:function(){$("#filteredTable>thead").append($("#filteredTable .filter-row")),$(".filtered-datepicker").daterangepicker({timePicker:!0,timePickerSeconds:!0,startDate:moment.unix(window.profile.dateTime.startedAt).format("MM/DD/YYYY"),endDate:moment.unix(window.profile.dateTime.endedAt).format("MM/DD/YYYY")},function(t,a,n){profile.dateTime={startedAt:t.unix(),endedAt:a.unix()},e.draw()}),$("#filteredTable").removeClass("loading")},drawCallback:function(){$("#filteredTable tbody").on("click","tr",function(){var e=$(this).find("[data-json]").data("json");$(".filteredModal .modal-body").JSONView(JSON.stringify(e)),$(".filteredModal").modal("show")}),$("#filteredTable").removeClass("loading"),$("html").animate({scrollTop:0},300)}});$("#filteredTable select.method, #filteredTable input.filtered-name, #filteredTable input.elapsed").off().on("input",function(){$("#filteredTable").addClass("loading"),e.draw()}),$(".clear-filter").off().on("click",function(){var t=$(".filtered-datepicker");$("#filteredTable select.method").val("ALL"),$("#filteredTable input.filtered-name").val(""),$("#filteredTable input.elapsed").val(""),t.data("daterangepicker").setStartDate(moment().subtract(7,"days").format("MM/DD/YYYY")),t.data("daterangepicker").setEndDate(moment().format("MM/DD/YYYY")),e.draw()})},getCharts=function(){$.ajax({type:"GET",async:!0,url:"api/measurements/methodDistribution/",dataType:"json",data:{startedAt:window.profile.dateTime.startedAt,endedAt:window.profile.dateTime.endedAt},success:function(e){var t=e.distribution,a=[];for(key in t)t.hasOwnProperty(key)&&a.push([key,t[key]]);c3.generate({bindto:"#pieChart",data:{columns:a,type:"pie",colors:{GET:"#4BB74B",PUT:"#0C8DFB",DELETE:"#FB6464",POST:"#2758E4"}},tooltip:{format:{value:function(e,t,a){return e}}},color:{pattern:["#9A9A9A"]}}),$("#pieChart").removeClass("loading")}}),$.ajax({type:"GET",async:!0,url:"api/measurements/timeseries/",dataType:"json",data:{interval:"hours"!==window.dayFilterValue?"daily":"hourly",startedAt:window.profile.dateTime.startedAt,endedAt:window.profile.dateTime.endedAt},success:function(e){var t=e.series,a=["data"],n=[];for(var r in t)a.push(t[r]);if("hours"===window.dayFilterValue)for(var r in Object.keys(t))n.push(Object.keys(t)[r].substr(-2,2));else n=Object.keys(t);c3.generate({bindto:"#lineChart",data:{columns:[a],type:"area"},axis:{x:{type:"category",categories:n}},legend:{show:!1},color:{pattern:["#EC5B19"]}}),$("#lineChart").removeClass("loading")}})};$(document).ready(function(){$('a[data-toggle="tab"]').historyTabs(),$("#big-users-table").on("preXhr.dt",function(e,t,a){window.profile.dataTableOption=a;var n=profile.createQueryParams("grouped",a);for(key in n)n.hasOwnProperty(key)&&(a[key]=n[key])});var e=$("#big-users-table").DataTable({processing:!0,serverSide:!0,ajax:{url:"api/measurements/grouped",dataSrc:function(e){return profile.dataTableClassifier(e.measurements).data}},responsive:!1,paging:!1,pageLength:1e4,dom:"Btrtip",stateSave:!0,autoWidth:!1,order:[2,"desc"],language:{processing:"Loading...",buttons:{colvis:'<span class="glyphicon glyphicon-filter"></span>'}},buttons:[{extend:"colvis",columns:[":gt(1)"]}],columns:[{title:"method",data:function(e){var t=$("<span></span>");return t.addClass("row--method"),t.addClass(e.method.toLowerCase()),t.text(e.method),t.prop("outerHTML")},class:"method",orderable:!1},{title:"name",data:function(e){var t=document.createElement("div");return t.textContent=e.name,t.textContent},class:"name",orderable:!1},{title:"count",data:"count",class:"number"},{title:"avg elapsed",data:function(e){return e.avgElapsed.toString().slice(0,8)},class:"number"},{title:"max elapsed",data:function(e){return e.maxElapsed.toString().slice(0,8)},class:"number"},{title:"min elapsed",data:function(e){return e.minElapsed.toString().slice(0,8)},class:"number"}],drawCallback:function(){$("#big-users-table tbody tr").off().on("click",function(e){if("A"!==$(e.target).prop("tagName")){var t=$(".filtered-datepicker");$("#filteredTable .filter-row .filtered-name").val($(this).find("td.name").text()).trigger("input"),$("#filteredTable .filter-row .method").val($(this).find(".method .row--method").text()).trigger("input"),"object"==typeof t.data("daterangepicker")&&(t.data("daterangepicker").setStartDate(moment.unix(window.profile.dateTime.startedAt).format("MM/DD/YYYY")),t.data("daterangepicker").setEndDate(moment.unix(window.profile.dateTime.endedAt).format("MM/DD/YYYY"))),setFilteredTable(),$('[data-target="#tab-filtering"]').tab("show")}})},initComplete:function(){}});$(document).on("popstate",function(e){console.log(e)}),$('[data-target="#tab-filtering"]').on("show.bs.tab",function(){setFilteredTable()}),$(".day-filter label").on("click",function(t){$("#lineChart, #pieChart").addClass("loading");var a;$(this).find("input").val();window.dayFilterValue,window.dayFilterValue=$(this).find("input").val(),a="min"===window.dayFilterValue?{startedAt:moment().subtract(1,"hours").unix(),endedAt:moment().unix()}:"hours"===window.dayFilterValue?{startedAt:moment().subtract(24,"hours").unix(),endedAt:moment().unix()}:"days"===window.dayFilterValue?{startedAt:moment().subtract(7,"days").unix(),endedAt:moment().unix()}:{startedAt:moment().subtract(30,"days").unix(),endedAt:moment().unix()},window.profile.dateTime=a,getCharts(),e.draw()}),getCharts(),function e(){$(".created-time").text("Created "+moment(profile.createdTime).fromNow()),setTimeout(e,5e3)}()}),$(document).on("show.bs.tab",'[data-target="#tab-filtering"]',function(e){setFilteredTable()});